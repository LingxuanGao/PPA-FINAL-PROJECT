---
title: "Eviction"
author:
  - "Lingxuan Gao"
  - "Xiaoqing Chen"
date: "`r Sys.Date()`"
format:
  html:
    code-fold: true
    code-tools: true
    toc: true
    toc-depth: 3
    toc-location: left
    theme: cosmo
    embed-resources: true
editor: visual
execute:
  warning: false
  message: false
---

# Introduction

------------------------------------------------------------------------

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  cache = TRUE
)

Sys.setlocale("LC_TIME", "English")
```

## Load Libraries

```{r load_libraries}
# Core tidyverse
library(tidyverse)
library(lubridate)

# Spatial data
library(sf)
library(tigris)

# Census data
library(tidycensus)

# Weather data
library(riem)  # For Philadelphia weather from ASOS stations

# Visualization
library(viridis)
library(gridExtra)
library(knitr)
library(kableExtra)
# Get rid of scientific notation. We gotta look good!
options(scipen = 999)
```

## Define Themes

```{r themes}
plotTheme <- theme(
  plot.title = element_text(size = 14, face = "bold"),
  plot.subtitle = element_text(size = 10),
  plot.caption = element_text(size = 8),
  axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
  axis.text.y = element_text(size = 10),
  axis.title = element_text(size = 11, face = "bold"),
  panel.background = element_blank(),
  panel.grid.major = element_line(colour = "#D0D0D0", size = 0.2),
  panel.grid.minor = element_blank(),
  axis.ticks = element_blank(),
  legend.position = "right"
)

mapTheme <- theme(
  plot.title = element_text(size = 14, face = "bold"),
  plot.subtitle = element_text(size = 10),
  plot.caption = element_text(size = 8),
  axis.line = element_blank(),
  axis.text = element_blank(),
  axis.ticks = element_blank(),
  axis.title = element_blank(),
  panel.background = element_blank(),
  panel.border = element_blank(),
  panel.grid.major = element_line(colour = 'transparent'),
  panel.grid.minor = element_blank(),
  legend.position = "right",
  plot.margin = margin(1, 1, 1, 1, 'cm'),
  legend.key.height = unit(1, "cm"),
  legend.key.width = unit(0.2, "cm")
)

palette5 <- c("#eff3ff", "#bdd7e7", "#6baed6", "#3182bd", "#08519c")
```

# 1. Data Source

## Load and clean all the datasets
```{r load data}

# Monthly totals vs baseline (city-wide)
philly_barchart <- readr::read_csv("data/philadelphia_barchart.csv") %>%
  mutate(
    # "01/2020" -> 2020-01-01
    date = my(month)
  )

# Claims severity over time
philly_claims_monthly <- readr::read_csv("data/philadelphia_claims_monthly.csv") %>%
  mutate(
    # already in ISO format like "2020-01-01"
    month_date = ymd(month_date)
  )

# Group-level (race, gender, etc.) monthly trends
philly_linechart <- readr::read_csv("data/philadelphia_linechart.csv") %>%
  mutate(
    # "11/2024" -> 2024-11-01
    month_date = my(month)
  )

# Census tract map snapshot
mapdata <- readr::read_csv("data/philadelphia_map.csv") %>%
  mutate(
    # "01/11/2024" likely means 01-11-2024 (1 November 2024)
    month_date = dmy(month_date)
  )

# Tract-level monthly pre/post pandemic
monthly <- readr::read_csv("data/philadelphia_monthly_2020_2021.csv") %>%
  mutate(
    month_date = my(month)
  )

# Tract-level weekly pre/post pandemic
weekly <- readr::read_csv("data/philadelphia_weekly_2020_2021.csv") %>%
  mutate(
    week_date = ymd(week_date)
  )

# Property code / license violations (point data)
violations <- readr::read_csv("data/li_violations.csv")

# Hotspot properties (top filers)
hotspots <- readr::read_csv("data/philadelphia_hotspots_media_report.csv") %>%
  mutate(
    time_period = ymd(time_period),
    end_date    = ymd(end_date)
  )



```

# 2. Exploratory Data Analysis

## 2.1 Temporal Analysis

We reorganized the monthly eviction-filing counts by grouping each month into a season (Winter, Spring, Summer, Fall).
We computed four separate seasonal baselines:

the historical average for Winter/Spring/Summer/Fall months

Then we produced a four-panel faceted plot to let us compare each season to what is “normal” for that season.

```{r season}

library(tidyverse)
library(lubridate)

# Add season column
philly_barchart2 <- philly_barchart %>%
  mutate(
    # extract month number
    m = month(date),
    season = case_when(
      m %in% c(12, 1, 2) ~ "Winter",
      m %in% c(3, 4, 5)  ~ "Spring",
      m %in% c(6, 7, 8)  ~ "Summer",
      m %in% c(9, 10, 11) ~ "Fall"
    )
  )

# Calculate true seasonal averages
season_baseline <- philly_barchart2 %>%
  group_by(season) %>%
  summarise(season_avg = mean(month_filings, na.rm = TRUE))

season_baseline


```


```{r seaon chart}

ggplot(philly_barchart2, aes(x = date, y = month_filings)) +
  geom_col(fill = "#3182bd") +
  geom_hline(
    data = season_baseline,
    aes(yintercept = season_avg),
    linetype = "dashed"
  ) +
  facet_wrap(~ season, ncol = 2, scales = "free_y") +
  labs(
    title = "Monthly Eviction Filings by Season",
    subtitle = "Each panel shows filings and seasonal baseline",
    x = "Date",
    y = "Eviction filings"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    strip.text = element_text(face = "bold", size = 13),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

```
**Patterns:**

1.Eviction filings were heavily suppressed across all seasons in 2020–2021.
Every season shows extremely low activity during the early pandemic period.

2.Beginning in 2022, filings rebound sharply—but not uniformly across seasons.
-Summer 2022 displays one of the largest spikes in the dataset.
-Fall and Spring quickly rise back to their historical levels.
-Winter rebounds more unevenly but eventually stabilizes.
So the seasonal cut reveals that the return to “normal” was staggered, with some seasons experiencing larger surges than others.

3.From 2023 onward, virtually every season settles at or slightly above its long-term seasonal baseline.
This indicates a new post-pandemic equilibrium where eviction activity has stabilized.

```{r eda_claim_severity}
# Median claim over time
p1 <- ggplot(philly_claims_monthly, aes(x = month_date, y = median_claim)) +
  geom_line() +
  geom_hline(aes(yintercept = median_claim_baseline), linetype = "dashed") +
  labs(
    title = "Median Eviction Claim Over Time",
    x = "Month",
    y = "Median claim amount ($)",
    caption = "Dashed line: pre-pandemic median claim"
  ) +
  plotTheme

# Share of very small vs very large claims
philly_claims_long <- philly_claims_monthly %>%
  select(month_date, sub1000, sub_med_rent, over_six_months_rent) %>%
  pivot_longer(
    cols = -month_date,
    names_to = "claim_type",
    values_to = "share"
  ) %>%
  mutate(
    claim_type = recode(
      claim_type,
      sub1000             = "Claims < $1,000",
      sub_med_rent        = "Claims < median rent",
      over_six_months_rent = "Claims > 6 months of rent"
    )
  )

p2 <- ggplot(philly_claims_long, aes(x = month_date, y = share, color = claim_type)) +
  geom_line() +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "Distribution of Claim Sizes Over Time",
    x = "Month",
    y = "Share of filings",
    color = NULL
  ) +
  plotTheme +
  theme(legend.position = "bottom")

gridExtra::grid.arrange(p1, p2, ncol = 1)
```

```{r}

ggplot(mapdata, aes(x = month_rate)) +
  geom_histogram(bins = 40, fill = "#3182bd", alpha = 0.8) +
  labs(
    title = "Distribution of Monthly Eviction Rates Across Tracts",
    x = "Eviction Rate (per tract)",
    y = "Count of tracts"
  ) +
  theme_minimal()


```

```{r}

ggplot(mapdata, aes(x = factor(year(month_date)), y = month_rate)) +
  geom_boxplot(fill = "#6baed6") +
  labs(
    title = "Tract-Level Eviction Rates Over Time",
    x = "Year",
    y = "Eviction Rate"
  ) +
  theme_minimal()


```
```{r}
threshold <- mapdata %>%
  summarise(cut = quantile(month_rate, 0.8, na.rm = TRUE)) %>%
  pull(cut)
threshold

tract_risk <- mapdata %>%
  mutate(high_risk = if_else(month_rate >= threshold, 1, 0)) %>%
  group_by(id) %>%
  summarise(
    times_high_risk = sum(high_risk, na.rm = TRUE),
    avg_rate = mean(month_rate, na.rm = TRUE)
  )

ggplot(tract_risk, aes(x = times_high_risk)) +
  geom_histogram(binwidth = 1, fill = "#cb181d") +
  labs(
    title = "How Many Times Did Each Tract Become High-Risk?",
    x = "Number of High-Risk Months",
    y = "Count of Tracts"
  ) +
  theme_minimal()

```

