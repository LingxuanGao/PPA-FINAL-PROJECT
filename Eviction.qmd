---
title: "Eviction"
author:
  - "Lingxuan Gao"
  - "Xiaoqing Chen"
date: "`r Sys.Date()`"
format:
  html:
    code-fold: true
    code-tools: true
    toc: true
    toc-depth: 3
    toc-location: left
    theme: cosmo
    embed-resources: true
editor: visual
execute:
  warning: false
  message: false
---

# Introduction

------------------------------------------------------------------------

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  cache = TRUE
)

Sys.setlocale("LC_TIME", "English")
```

## Load Libraries

```{r load_libraries}
# Core tidyverse
library(tidyverse)
library(lubridate)

# Spatial data
library(sf)
library(tigris)

# Census data
library(tidycensus)

# Weather data
library(riem)  # For Philadelphia weather from ASOS stations

# Visualization
library(viridis)
library(gridExtra)
library(knitr)
library(kableExtra)
# Get rid of scientific notation. We gotta look good!
options(scipen = 999)
```

## Define Themes

```{r themes}
plotTheme <- theme(
  plot.title = element_text(size = 14, face = "bold"),
  plot.subtitle = element_text(size = 10),
  plot.caption = element_text(size = 8),
  axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
  axis.text.y = element_text(size = 10),
  axis.title = element_text(size = 11, face = "bold"),
  panel.background = element_blank(),
  panel.grid.major = element_line(colour = "#D0D0D0", size = 0.2),
  panel.grid.minor = element_blank(),
  axis.ticks = element_blank(),
  legend.position = "right"
)

mapTheme <- theme(
  plot.title = element_text(size = 14, face = "bold"),
  plot.subtitle = element_text(size = 10),
  plot.caption = element_text(size = 8),
  axis.line = element_blank(),
  axis.text = element_blank(),
  axis.ticks = element_blank(),
  axis.title = element_blank(),
  panel.background = element_blank(),
  panel.border = element_blank(),
  panel.grid.major = element_line(colour = 'transparent'),
  panel.grid.minor = element_blank(),
  legend.position = "right",
  plot.margin = margin(1, 1, 1, 1, 'cm'),
  legend.key.height = unit(1, "cm"),
  legend.key.width = unit(0.2, "cm")
)

palette5 <- c("#eff3ff", "#bdd7e7", "#6baed6", "#3182bd", "#08519c")
```

# 1. Data Source

## Load and clean all the datasets
```{r load data}

# Monthly totals vs baseline (city-wide)
philly_barchart <- readr::read_csv("data/philadelphia_barchart.csv") %>%
  mutate(
    # "01/2020" -> 2020-01-01
    date = my(month)
  )

# Claims severity over time
philly_claims_monthly <- readr::read_csv("data/philadelphia_claims_monthly.csv") %>%
  mutate(
    # already in ISO format like "2020-01-01"
    month_date = ymd(month_date)
  )

# Group-level (race, gender, etc.) monthly trends
philly_linechart <- readr::read_csv("data/philadelphia_linechart.csv") %>%
  mutate(
    # "11/2024" -> 2024-11-01
    month_date = my(month)
  )

# Census tract map snapshot
philly_map <- readr::read_csv("data/philadelphia_map.csv") %>%
  mutate(
    # "01/11/2024" likely means 01-11-2024 (1 November 2024)
    month_date = dmy(month_date)
  )

# Tract-level monthly pre/post pandemic
philly_monthly_2020_2021 <- readr::read_csv("data/philadelphia_monthly_2020_2021.csv") %>%
  mutate(
    month_date = my(month)
  )

# Tract-level weekly pre/post pandemic
philly_weekly_2020_2021 <- readr::read_csv("data/philadelphia_weekly_2020_2021.csv") %>%
  mutate(
    week_date = ymd(week_date)
  )

# Property code / license violations (point data)
li_violations <- readr::read_csv("data/li_violations.csv")

# Hotspot properties (top filers)
philly_hotspots <- readr::read_csv("data/philadelphia_hotspots_media_report.csv") %>%
  mutate(
    time_period = ymd(time_period),
    end_date    = ymd(end_date)
  )

# Quick sanity checks
glimpse(philly_barchart)
glimpse(philly_claims_monthly)
glimpse(philly_linechart)
glimpse(philly_map)
glimpse(philly_monthly_2020_2021)
glimpse(philly_weekly_2020_2021)
glimpse(li_violations)
glimpse(philly_hotspots)


```

# 2. Exploratory Data Analysis

## 1.1 Temporal Analysis

```{r Temporal Analysis}

ggplot(philly_barchart, aes(x = date, y = month_filings)) +
  geom_line(color = "#3182bd", size = 1) +
  geom_point(color = "#08519c", size = 1.5) +
  labs(
    title = "Monthly Eviction Filings in Philadelphia",
    subtitle = "Trend from 2020 to 2024",
    x = "Date",
    y = "Number of Filings",
    caption = "Source: Eviction Lab Philadelphia Tracking"
  ) +
  plotTheme

```
