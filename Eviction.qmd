---
title: "Eviction Risk in Philadelphia"
author:
  - "Lingxuan Gao"
  - "Xiaoqing Chen"
date: "`r Sys.Date()`"
format:
  html:
    code-fold: true
    code-tools: true
    toc: true
    toc-depth: 3
    toc-location: left
    theme: cosmo
    embed-resources: true
editor: visual
execute:
  warning: false
  message: false
---

# Introduction

------------------------------------------------------------------------

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  cache = TRUE
)

Sys.setlocale("LC_TIME", "English")
```

## Load Libraries

```{r load_libraries}
# Core tidyverse
library(tidyverse)
library(lubridate)

# Spatial data
library(sf)
library(tigris)

# Census data
library(tidycensus)

# Weather data
library(riem)  # For Philadelphia weather from ASOS stations

# Visualization
library(viridis)
library(gridExtra)
library(knitr)
library(kableExtra)
# Get rid of scientific notation. We gotta look good!
options(scipen = 999)
```

## Define Themes

```{r themes}
plotTheme <- theme(
  plot.title = element_text(size = 14, face = "bold"),
  plot.subtitle = element_text(size = 10),
  plot.caption = element_text(size = 8),
  axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
  axis.text.y = element_text(size = 10),
  axis.title = element_text(size = 11, face = "bold"),
  panel.background = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  axis.ticks = element_blank(),
  legend.position = "right"
)

mapTheme <- theme(
  plot.title = element_text(size = 14, face = "bold"),
  plot.subtitle = element_text(size = 10),
  plot.caption = element_text(size = 8),
  axis.line = element_blank(),
  axis.text = element_blank(),
  axis.ticks = element_blank(),
  axis.title = element_blank(),
  panel.background = element_blank(),
  panel.border = element_blank(),
  panel.grid.major = element_line(colour = 'transparent'),
  panel.grid.minor = element_blank(),
  legend.position = "right",
  plot.margin = margin(1, 1, 1, 1, 'cm'),
  legend.key.height = unit(1, "cm"),
  legend.key.width = unit(0.2, "cm")
)

palette5 <- c("#eff3ff", "#bdd7e7", "#6baed6", "#3182bd", "#08519c")
```

# 1. Data Source

## Load and clean all the datasets
```{r load data}

# Monthly totals vs baseline (city-wide)
philly_barchart <- readr::read_csv("data/philadelphia_barchart.csv") %>%
  mutate(
    date = lubridate::my(month)
  )

# Claims severity over time
philly_claims_monthly <- readr::read_csv("data/philadelphia_claims_monthly.csv") %>%
  mutate(
    month_date = lubridate::ymd(month_date)
  )

# Group-level (race, gender, etc.) monthly trends
philly_linechart <- readr::read_csv("data/philadelphia_linechart.csv") %>%
  mutate(
    month_date = lubridate::my(month)
  )

# Census tract map snapshot
philly_map <- readr::read_csv("data/philadelphia_map.csv") %>%
  mutate(
   GEOID = as.character(id),
    month_date = lubridate::dmy(month_date)
  )

# Tract-level monthly pre/post pandemic
philly_monthly <- readr::read_csv("data/philadelphia_monthly_2020_2021.csv") %>%
  mutate(
    month_date = lubridate::my(month)
  )

# Tract-level weekly 
weekly <- readr::read_csv("data/philadelphia_weekly_2020_2021.csv") %>%
  mutate(
    week_date = lubridate::ymd(week_date)
  )

# Code / license violations (point data, older)
li_violations <- readr::read_csv("data/li_violations.csv")

# Hotspot properties (top filers)
hotspots <- readr::read_csv("data/philadelphia_hotspots_media_report.csv") %>%
  mutate(
    time_period = lubridate::ymd(time_period),
    end_date    = lubridate::ymd(end_date)
  )



```

Now we have:
- **City-level series** (`philly_barchart`)
- **Tract-level monthly data over multiple years** (`philly_monthly`)
- **Snapshot map** (`philly_map`)
- **Group-level disparities** (`philly_linechart`)
- **Structural context** (historical violations, hotspot landlords)

# 2. Exploratory Data Analysis

## 2.1 Citywide filings over time

We reorganized the monthly eviction-filing counts by grouping each month into a season (Winter, Spring, Summer, Fall).
We computed four separate seasonal baselines:

the historical average for Winter/Spring/Summer/Fall months

Then we produced a four-panel faceted plot to let us compare each season to what is “normal” for that season.

```{r season}

library(tidyverse)
library(lubridate)

# Add season column
philly_barchart2 <- philly_barchart %>%
  mutate(
    # extract month number
    m = month(date),
    season = case_when(
      m %in% c(12, 1, 2) ~ "Winter",
      m %in% c(3, 4, 5)  ~ "Spring",
      m %in% c(6, 7, 8)  ~ "Summer",
      m %in% c(9, 10, 11) ~ "Fall"
    )
  )

# Calculate true seasonal averages
season_baseline <- philly_barchart2 %>%
  group_by(season) %>%
  summarise(season_avg = mean(month_filings, na.rm = TRUE))

season_baseline


```

```{r seaon chart}

ggplot(philly_barchart2, aes(x = date, y = month_filings)) +
  geom_col(fill = "#3182bd") +
  geom_hline(
    data = season_baseline,
    aes(yintercept = season_avg),
    linetype = "dashed"
  ) +
  facet_wrap(~ season, ncol = 2, scales = "free_y") +
  labs(
    title = "Monthly Eviction Filings by Season",
    subtitle = "Each panel shows filings and seasonal baseline",
    x = "Date",
    y = "Eviction filings"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    strip.text = element_text(face = "bold", size = 13),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

```
**Patterns:**

1.Eviction filings were heavily suppressed across all seasons in 2020–2021.
Every season shows extremely low activity during the early pandemic period.

2.Beginning in 2022, filings rebound sharply—but not uniformly across seasons.
-Summer 2022 displays one of the largest spikes in the dataset.
-Fall and Spring quickly rise back to their historical levels.
-Winter rebounds more unevenly but eventually stabilizes.
So the seasonal cut reveals that the return to “normal” was staggered, with some seasons experiencing larger surges than others.

3.From 2023 onward, virtually every season settles at or slightly above its long-term seasonal baseline.
This indicates a new post-pandemic equilibrium where eviction activity has stabilized.

```{r eda_claim_severity}
# Median claim over time
p1 <- ggplot(philly_claims_monthly, aes(x = month_date, y = median_claim)) +
  geom_line() +
  geom_hline(aes(yintercept = median_claim_baseline), linetype = "dashed") +
  labs(
    title = "Median Eviction Claim Over Time",
    x = "Month",
    y = "Median claim amount ($)",
    caption = "Dashed line: pre-pandemic median claim"
  ) +
  plotTheme

# Share of very small vs very large claims
philly_claims_long <- philly_claims_monthly %>%
  select(month_date, sub1000, sub_med_rent, over_six_months_rent) %>%
  pivot_longer(
    cols = -month_date,
    names_to = "claim_type",
    values_to = "share"
  ) %>%
  mutate(
    claim_type = recode(
      claim_type,
      sub1000             = "Claims < $1,000",
      sub_med_rent        = "Claims < median rent",
      over_six_months_rent = "Claims > 6 months of rent"
    )
  )

p2 <- ggplot(philly_claims_long, aes(x = month_date, y = share, color = claim_type)) +
  geom_line() +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "Distribution of Claim Sizes Over Time",
    x = "Month",
    y = "Share of filings",
    color = NULL
  ) +
  plotTheme +
  theme(legend.position = "bottom")

gridExtra::grid.arrange(p1, p2, ncol = 1)
```

## 2.2 Tract-level risk and spatial patterns

We uses the multi-year tract-level monthly data to see how skewed filings are across tracts.

```{r eda_tract_distribution}
tract_annual <- philly_monthly %>%
  group_by(GEOID) %>%
  summarize(
    total_filings = sum(filings_2020, na.rm = TRUE),
    mean_monthly  = mean(filings_2020, na.rm = TRUE),
    n_months      = n(),
    .groups = "drop"
  )

# Add a vertical line at the 80th percentile (top 20%)
p80 <- quantile(tract_annual$mean_monthly, 0.80, na.rm = TRUE)

ggplot(tract_annual, aes(x = mean_monthly)) +
  geom_histogram(bins = 30, fill = "#3182bd") +
  geom_vline(xintercept = p80, linetype = "dashed", color = "red") +
  labs(
    title = "Distribution of Mean Monthly Eviction Filings per Tract",
    subtitle = paste0("Dashed line = 80th percentile (candidate high-risk cutoff: ",
                      round(p80, 2), " filings/month)"),
    x = "Mean monthly filings (multi-year)",
    y = "Number of tracts"
  ) +
  plotTheme

```

This histogram shows that most census tracts have very low average eviction activity—often fewer than 2 filings per month.A small number of tracts sit far to the right, with 5–10+ filings per month, meaning they experience consistently high eviction pressure over multiple years.
So eviction risk in Philly is highly **concentrated**, not evenly spread, which supports focusing limited legal aid and rent subsidies on that right-tail group of chronic hotspot tracts.

### Load Spatial Data
```{r}

library(sf)
library(tidyverse)
library(viridis)
library(lubridate)

# Read your GeoJSONs
boundary <- st_read("data/City_Limits.geojson")
pa_tracts <- st_read("data/PA-tracts.geojson")

# Join eviction data with tract geometry
philly_tracts <- pa_tracts %>%
  filter(str_starts(GEOID, "42101"))

philly_map <- philly_map %>%
  mutate(id = as.character(id))

philly_tracts <- philly_tracts %>%
  mutate(GEOID = as.character(GEOID))


map_sf <- philly_tracts %>%
  left_join(philly_map, by = c("GEOID" = "id"))
```

### Eviction rate map since Nov 2024
```{r}

ggplot(
  map_sf %>% filter(!is.na(month_rate))
) +
  geom_sf(aes(fill = month_rate), color = NA) +
  scale_fill_viridis(option = "magma", direction = -1) +
  labs(
    title = "Eviction Filing Rate by Census Tract (Nov 2024–Nov 2025)",
    fill  = "Eviction Rate"
  ) +
  coord_sf(datum = NA) +
  theme_void() +
  theme(
    legend.position = "right",
    plot.title      = element_text(size = 14, face = "bold")
  )


```

```{r}

map_compare <- map_sf %>%
  mutate(
    # month_diff is a ratio vs baseline
    diff_vs_baseline = month_diff - 1
  )

ggplot(
  map_compare %>% filter(!is.na(diff_vs_baseline))
) +
  geom_sf(aes(fill = diff_vs_baseline), color = NA) +
  scale_fill_gradient2(
    low  = "#4575b4",
    mid  = "white",
    high = "#d73027",
    midpoint = 0,
    labels = scales::percent_format(accuracy = 1),
    name = "Change vs baseline\n(2023–24)"
  ) +
  labs(
    title    = "Eviction Filing Rate by Census Tract",
    subtitle = "Nov 2024–Nov 2025 vs typical 2023–2024 rate"
  ) +
  coord_sf(datum = NA) +
  theme_void() +
  theme(
    legend.position = "right",
    plot.title      = element_text(size = 14, face = "bold"),
    plot.subtitle   = element_text(size = 10)
  )


```

Philly isn’t on fire everywhere—a handful of neighborhoods are overheating while others are holding steady or cooling down. Those red clusters are exactly where we’d point legal aid and rent relief first.

### Persistence of high-risk tracts (spatial pattern)
```{r}
threshold <- quantile(map_sf$month_rate, 0.8, na.rm = TRUE)

tract_risk <- map_sf %>%
  st_drop_geometry() %>%                        # strip geometry
  mutate(high = if_else(month_rate >= threshold, 1L, 0L)) %>%
  group_by(GEOID) %>%
  summarise(
    times_high = sum(high, na.rm = TRUE),
    .groups = "drop"
  )

risk_sf <- philly_tracts %>%
  left_join(tract_risk, by = "GEOID")          # now y is NOT sf → OK

ggplot(risk_sf) +
  geom_sf(aes(fill = times_high), color = NA) +
  scale_fill_viridis_c(option = "inferno") +
  labs(
    title = "Persistence of High Eviction Risk Across Tracts",
    fill  = "Months above 80th percentile"
  ) +
  theme_minimal()


```

```{r eda_group_disparities}
philly_linechart_share <- philly_linechart %>%
  group_by(month) %>%
  mutate(
    share = month_filings / sum(month_filings, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  mutate(month_date = lubridate::my(month))  # "11/2024" → 2024-11-01

ggplot(
  philly_linechart_share,
  aes(x = month_date, y = share, color = group)
) +
  geom_line() +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title    = "Share of Eviction Filings by Group Over Time",
    subtitle = "Each month: group's filings / total filings",
    x = "Month",
    y = "Share of filings",
    color = "Group"
  ) +
  plotTheme +
  theme(legend.position = "bottom")

```

### Hotspot landlords (top eviction filers)
```{r}
hotspot_sf <- st_as_sf(
  hotspots,
  coords = c("lon", "lat"),
  crs = 4326
)

ggplot() +
  geom_sf(data = boundary, fill = "grey95", color = NA) +
  geom_sf(data = hotspot_sf, aes(size = filings), alpha = 0.6, color = "#d7301f") +
  scale_size(range = c(1, 10)) +
  labs(
    title = "Top Eviction-Filing Landlords in Philadelphia",
    subtitle = "Bubble size shows number of filings",
    size = "Filings"
  ) +
  theme_minimal()
```


# 3.Get Philadelphia Spatial Context

Now we shift from “describe” to “explain”:  
We want to add **structural predictors**:

- Demographics & housing (ACS)  
- Landlord concentration (hotspots)  
- Housing quality (old violations)

## 3.1 Base tract list
```{r spatial_base}
# One row per tract ID from the joined spatial layer
tract_base <- map_sf %>%
  sf::st_drop_geometry() %>%
  dplyr::distinct(GEOID) %>%
  dplyr::arrange(GEOID)
```


---

### 3.2 Add ACS demographics & housing

```{r spatial_acs, message=FALSE, warning=FALSE}
acs_vars <- c(
  total_pop  = "B01003_001",  # total population
  pov_total  = "B17001_001",  # poverty universe
  pov_below  = "B17001_002",  # below poverty
  occ_total  = "B25003_001",  # occupied housing units
  occ_renter = "B25003_003",  # renter-occupied units
  med_rent   = "B25064_001",  # median gross rent
  white      = "B03002_003",
  black      = "B03002_004",
  hispanic   = "B03002_012"
)

acs_philly <- tidycensus::get_acs(
  geography = "tract",
  state     = "PA",
  county    = "Philadelphia",
  survey    = "acs5",
  year      = 2022,
  variables = acs_vars,
  output    = "wide",
  geometry  = FALSE
) %>%
  dplyr::transmute(
    GEOID,
    total_pop    = total_popE,
    pov_rate     = dplyr::if_else(pov_totalE > 0, pov_belowE / pov_totalE, NA_real_),
    renter_share = dplyr::if_else(occ_totalE > 0, occ_renterE / occ_totalE, NA_real_),
    med_rent     = med_rentE,
    pct_black    = dplyr::if_else(total_popE > 0, blackE / total_popE, NA_real_),
    pct_hispanic = dplyr::if_else(total_popE > 0, hispanicE / total_popE, NA_real_)
  )

# Attach ACS to tract base and to the spatial object
tract_context <- tract_base %>%
  dplyr::left_join(acs_philly, by = "GEOID")

map_sf_context <- map_sf %>%
  dplyr::left_join(acs_philly, by = "GEOID")
```

