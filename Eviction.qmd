---
title: "Eviction"
author:
  - "Lingxuan Gao"
  - "Xiaoqing Chen"
date: "`r Sys.Date()`"
format:
  html:
    code-fold: true
    code-tools: true
    toc: true
    toc-depth: 3
    toc-location: left
    theme: cosmo
    embed-resources: true
editor: visual
execute:
  warning: false
  message: false
---

# Introduction

------------------------------------------------------------------------

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  cache = TRUE
)

Sys.setlocale("LC_TIME", "English")
```

## Load Libraries

```{r load_libraries}
# Core tidyverse
library(tidyverse)
library(lubridate)

# Spatial data
library(sf)
library(tigris)

# Census data
library(tidycensus)

# Weather data
library(riem)  # For Philadelphia weather from ASOS stations

# Visualization
library(viridis)
library(gridExtra)
library(knitr)
library(kableExtra)
# Get rid of scientific notation. We gotta look good!
options(scipen = 999)
```

## Define Themes

```{r themes}
plotTheme <- theme(
  plot.title = element_text(size = 14, face = "bold"),
  plot.subtitle = element_text(size = 10),
  plot.caption = element_text(size = 8),
  axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
  axis.text.y = element_text(size = 10),
  axis.title = element_text(size = 11, face = "bold"),
  panel.background = element_blank(),
  panel.grid.major = element_line(colour = "#D0D0D0", size = 0.2),
  panel.grid.minor = element_blank(),
  axis.ticks = element_blank(),
  legend.position = "right"
)

mapTheme <- theme(
  plot.title = element_text(size = 14, face = "bold"),
  plot.subtitle = element_text(size = 10),
  plot.caption = element_text(size = 8),
  axis.line = element_blank(),
  axis.text = element_blank(),
  axis.ticks = element_blank(),
  axis.title = element_blank(),
  panel.background = element_blank(),
  panel.border = element_blank(),
  panel.grid.major = element_line(colour = 'transparent'),
  panel.grid.minor = element_blank(),
  legend.position = "right",
  plot.margin = margin(1, 1, 1, 1, 'cm'),
  legend.key.height = unit(1, "cm"),
  legend.key.width = unit(0.2, "cm")
)

palette5 <- c("#eff3ff", "#bdd7e7", "#6baed6", "#3182bd", "#08519c")
```

# 1. Data Source

## Load and clean all the datasets
```{r load data}

# Monthly totals vs baseline (city-wide)
philly_barchart <- readr::read_csv("data/philadelphia_barchart.csv") %>%
  mutate(
    # "01/2020" -> 2020-01-01
    date = my(month)
  )

# Claims severity over time
philly_claims_monthly <- readr::read_csv("data/philadelphia_claims_monthly.csv") %>%
  mutate(
    # already in ISO format like "2020-01-01"
    month_date = ymd(month_date)
  )

# Group-level (race, gender, etc.) monthly trends
philly_linechart <- readr::read_csv("data/philadelphia_linechart.csv") %>%
  mutate(
    # "11/2024" -> 2024-11-01
    month_date = my(month)
  )

# Census tract map snapshot
mapdata <- readr::read_csv("data/philadelphia_map.csv") %>%
  mutate(
    # "01/11/2024" likely means 01-11-2024 (1 November 2024)
    month_date = dmy(month_date)
  )

# Tract-level monthly pre/post pandemic
monthly <- readr::read_csv("data/philadelphia_monthly_2020_2021.csv") %>%
  mutate(
    month_date = my(month)
  )

# Tract-level weekly pre/post pandemic
weekly <- readr::read_csv("data/philadelphia_weekly_2020_2021.csv") %>%
  mutate(
    week_date = ymd(week_date)
  )

# Hotspot properties (top filers)
hotspots <- readr::read_csv("data/philadelphia_hotspots_media_report.csv") %>%
  mutate(
    time_period = ymd(time_period),
    end_date    = ymd(end_date)
  )



```

# 2. Exploratory Data Analysis

## 2.1 Temporal Analysis

We reorganized the monthly eviction-filing counts by grouping each month into a season (Winter, Spring, Summer, Fall).
We computed four separate seasonal baselines:

the historical average for Winter/Spring/Summer/Fall months

Then we produced a four-panel faceted plot to let us compare each season to what is “normal” for that season.

```{r season}

library(tidyverse)
library(lubridate)

# Add season column
philly_barchart2 <- philly_barchart %>%
  mutate(
    # extract month number
    m = month(date),
    season = case_when(
      m %in% c(12, 1, 2) ~ "Winter",
      m %in% c(3, 4, 5)  ~ "Spring",
      m %in% c(6, 7, 8)  ~ "Summer",
      m %in% c(9, 10, 11) ~ "Fall"
    )
  )

# Calculate true seasonal averages
season_baseline <- philly_barchart2 %>%
  group_by(season) %>%
  summarise(season_avg = mean(month_filings, na.rm = TRUE))

season_baseline


```


```{r seaon chart}

ggplot(philly_barchart2, aes(x = date, y = month_filings)) +
  geom_col(fill = "#3182bd") +
  geom_hline(
    data = season_baseline,
    aes(yintercept = season_avg),
    linetype = "dashed"
  ) +
  facet_wrap(~ season, ncol = 2, scales = "free_y") +
  labs(
    title = "Monthly Eviction Filings by Season",
    subtitle = "Each panel shows filings and seasonal baseline",
    x = "Date",
    y = "Eviction filings"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    strip.text = element_text(face = "bold", size = 13),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

```
**Patterns:**

1.Eviction filings were heavily suppressed across all seasons in 2020–2021.
Every season shows extremely low activity during the early pandemic period.

2.Beginning in 2022, filings rebound sharply—but not uniformly across seasons.
-Summer 2022 displays one of the largest spikes in the dataset.
-Fall and Spring quickly rise back to their historical levels.
-Winter rebounds more unevenly but eventually stabilizes.
So the seasonal cut reveals that the return to “normal” was staggered, with some seasons experiencing larger surges than others.

3.From 2023 onward, virtually every season settles at or slightly above its long-term seasonal baseline.
This indicates a new post-pandemic equilibrium where eviction activity has stabilized.

```{r eda_claim_severity}
# Median claim over time
p1 <- ggplot(philly_claims_monthly, aes(x = month_date, y = median_claim)) +
  geom_line() +
  geom_hline(aes(yintercept = median_claim_baseline), linetype = "dashed") +
  labs(
    title = "Median Eviction Claim Over Time",
    x = "Month",
    y = "Median claim amount ($)",
    caption = "Dashed line: pre-pandemic median claim"
  ) +
  plotTheme

# Share of very small vs very large claims
philly_claims_long <- philly_claims_monthly %>%
  select(month_date, sub1000, sub_med_rent, over_six_months_rent) %>%
  pivot_longer(
    cols = -month_date,
    names_to = "claim_type",
    values_to = "share"
  ) %>%
  mutate(
    claim_type = recode(
      claim_type,
      sub1000             = "Claims < $1,000",
      sub_med_rent        = "Claims < median rent",
      over_six_months_rent = "Claims > 6 months of rent"
    )
  )

p2 <- ggplot(philly_claims_long, aes(x = month_date, y = share, color = claim_type)) +
  geom_line() +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "Distribution of Claim Sizes Over Time",
    x = "Month",
    y = "Share of filings",
    color = NULL
  ) +
  plotTheme +
  theme(legend.position = "bottom")

gridExtra::grid.arrange(p1, p2, ncol = 1)
```

## 2.2 Spatial Analysis

### Load Spatial Data
```{r}

library(sf)
library(tidyverse)
library(viridis)
library(lubridate)

# Read your GeoJSONs
boundary <- st_read("data/City_Limits.geojson")
pa_tracts <- st_read("data/PA-tracts.geojson")

# Join eviction data with tract geometry
philly_tracts <- pa_tracts %>%
  filter(str_starts(GEOID, "42101"))

mapdata <- mapdata %>%
  mutate(id = as.character(id))

philly_tracts <- philly_tracts %>%
  mutate(GEOID = as.character(GEOID))


map_sf <- philly_tracts %>%
  left_join(mapdata, by = c("GEOID" = "id"))
```

### Eviction rate map for the Nov 2024
```{r}
latest_month <- max(map_sf$month_date, na.rm = TRUE)

ggplot(
  map_sf %>% filter(month_date == latest_month)
) +
  geom_sf(aes(fill = month_rate), color = NA) +
  scale_fill_viridis(option = "magma", direction = -1) +
  labs(
    title = paste0("Eviction Filing Rate by Census Tract – ", latest_month),
    fill  = "Eviction Rate"
  ) +
  theme_minimal()


```
### Persistence of high-risk tracts (spatial pattern)
```{r}
threshold <- quantile(map_sf$month_rate, 0.8, na.rm = TRUE)

tract_risk <- map_sf %>%
  st_drop_geometry() %>%                        # strip geometry
  mutate(high = if_else(month_rate >= threshold, 1L, 0L)) %>%
  group_by(GEOID) %>%
  summarise(
    times_high = sum(high, na.rm = TRUE),
    .groups = "drop"
  )

risk_sf <- philly_tracts %>%
  left_join(tract_risk, by = "GEOID")          # now y is NOT sf → OK

ggplot(risk_sf) +
  geom_sf(aes(fill = times_high), color = NA) +
  scale_fill_viridis_c(option = "inferno") +
  labs(
    title = "Persistence of High Eviction Risk Across Tracts",
    fill  = "Months above 80th percentile"
  ) +
  theme_minimal()


```

### Hotspot landlords (top eviction filers)
```{r}
hotspot_sf <- st_as_sf(
  hotspots,
  coords = c("lon", "lat"),
  crs = 4326
)

ggplot() +
  geom_sf(data = boundary, fill = "grey95", color = NA) +
  geom_sf(data = hotspot_sf, aes(size = filings), alpha = 0.6, color = "#d7301f") +
  scale_size(range = c(1, 10)) +
  labs(
    title = "Top Eviction-Filing Landlords in Philadelphia",
    subtitle = "Bubble size shows number of filings",
    size = "Filings"
  ) +
  theme_minimal()
```

### Combined risk (eviction × violations × landlord concentration)
```{r}
ggplot() +
  geom_sf(data = map_sf %>% filter(month_date == latest_month),
          aes(fill = month_rate), color = NA) +
  scale_fill_viridis(option = "magma", direction = -1) +

  geom_sf(data = viol_sf %>% sample_n(3000),
          color = "white", size = 0.3, alpha = 0.3) +

  geom_sf(data = hotspot_sf,
          aes(size = filings), color = "#f03b20", alpha = 0.6) +

  labs(
    title = "Composite Risk Map: Eviction Rates + Violations + Landlord Hotspots",
    subtitle = "A multilayer spatial risk view for policy targeting",
    fill = "Eviction rate",
    size = "Landlord filings"
  ) +
  theme_minimal()
```

